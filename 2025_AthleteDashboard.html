<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Swimmer Performance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    @media print {
      .no-print { display: none !important; }
      .print\:block { display: block !important; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-3xl font-bold text-center mb-6">Swimmer Performance Dashboard</h1>

    <!-- Filter Controls -->
    <div class="no-print bg-gray-50 p-4 rounded-md shadow mb-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div>
          <label for="filterName" class="block font-medium text-sm mb-1">Swimmer Name</label>
          <input type="text" id="filterName" class="w-full p-2 border border-gray-300 rounded" />
        </div>
        <div>
          <label for="filterStroke" class="block font-medium text-sm mb-1">Stroke</label>
          <select id="filterStroke" class="w-full p-2 border border-gray-300 rounded">
            <option value="">All</option>
            <option>Freestyle</option>
            <option>Backstroke</option>
            <option>Breaststroke</option>
            <option>Butterfly</option>
            <option>IM</option>
          </select>
        </div>
        <div>
          <label for="seasonFilter" class="block font-medium text-sm mb-1">Season (Year)</label>
          <select id="seasonFilter" class="w-full p-2 border border-gray-300 rounded">
            <option value="">All</option>
            <option>2021</option>
            <option>2022</option>
            <option>2023</option>
            <option>2024</option>
            <option>2025</option>
          </select>
        </div>
        <div>
          <label for="toggleMeetScope" class="block font-medium text-sm mb-1">Meets Display</label>
          <select id="toggleMeetScope" class="w-full p-2 border border-gray-300 rounded">
            <option value="timesOnly">Meets With Results</option>
            <option value="allMeets">All Meets</option>
          </select>
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-4">
        <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">
          Apply Filters
        </button>
        <button id="resetFilters" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md shadow">
          Reset Filters
        </button>
        <button id="printReport" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md shadow ml-auto">
          Print
        </button>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
      <div class="bg-white p-4 shadow rounded-lg">
        <h2 class="text-lg font-bold mb-2">Specialty Radar</h2>
        <canvas id="specialtyChart"></canvas>
      </div>
      <div class="bg-white p-4 shadow rounded-lg">
        <h2 class="text-lg font-bold mb-2">Progression Chart</h2>
        <canvas id="progressionChart"></canvas>
      </div>
    </div>

    <!-- Select Event and Swimmer -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <label for="selectSwimmer" class="block font-medium text-sm mb-1">Select Swimmer</label>
        <select id="selectSwimmer" class="w-full p-2 border border-gray-300 rounded">
          <option value="">-- Choose --</option>
        </select>
      </div>
      <div>
        <label for="selectEventForProgression" class="block font-medium text-sm mb-1">Select Event</label>
        <select id="selectEventForProgression" class="w-full p-2 border border-gray-300 rounded" disabled>
          <option value="">-- Choose --</option>
        </select>
      </div>
    </div>

    <!-- Table Placeholder -->
    <table id="reportTable" class="w-full text-sm border border-gray-200">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="p-2">Meet Date</th>
          <th class="p-2">Meet</th>
          <th class="p-2">Event</th>
          <th class="p-2">Seed</th>
          <th class="p-2">Final</th>
          <th class="p-2">Place</th>
          <th class="p-2">Points</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <!-- Populated by JS -->
      </tbody>
    </table>
  </div>

<script>
// ==== NEW CONFIGURATIONS ====
let progressionToggle = localStorage.getItem('showAllMeets') === 'true';
let selectedSeason = localStorage.getItem('selectedSeason') || 'All';

// === Event Name Normalization ===
function normalizeEventName(rawName) {
  const regex = /\d{2}-\d{2}\s|\d{2}\s|\d{1,2}-\d{1,2}\s|\d{4}\s|\d+\s*yrs?\s*/gi;
  return rawName.replace(regex, '').trim();
}

// === Season Filter ===
function populateSeasonFilter(years) {
  const filter = document.getElementById('filterSeason');
  filter.innerHTML = '<option value="All">All Seasons</option>' +
    years.map(year => `<option value="${year}">${year}</option>`).join('');
  filter.value = selectedSeason;
}

function applySeasonFilter(data) {
  if (selectedSeason === 'All') return data;
  return data.filter(d => new Date(d.meetDate).getFullYear().toString() === selectedSeason);
}

// === Toggle Button Handling ===
function setupProgressionToggle() {
  const toggle = document.getElementById('toggleMeetScope');
  toggle.checked = progressionToggle;
  toggle.addEventListener('change', () => {
    progressionToggle = toggle.checked;
    localStorage.setItem('showAllMeets', progressionToggle);
    if (selectSwimmer.value && selectEventForProgression.value) {
      updateProgressionChart(selectSwimmer.value, selectEventForProgression.value);
    }
  });
}

// === Override existing chart data logic ===
function getProgressionChartData(swimmerId, selectedEvent) {
  const normalizedEvent = normalizeEventName(selectedEvent);
  const data = allAthleteData.filter(d =>
    d.id === swimmerId && normalizeEventName(d.eventSwum) === normalizedEvent &&
    !['NT', 'NS', 'DQ'].includes(d.resultTime)
  ).sort((a, b) => new Date(a.meetDate) - new Date(b.meetDate));

  const labels = data.map(d => formatMMDDYYYY(d.meetDate));
  const times = data.map(d => timeToSeconds(d.resultTime));

  return {
    labels,
    datasets: [{
      label: `${normalizedEvent} Progression`,
      data: times,
      fill: false,
      borderColor: 'rgb(75, 192, 192)',
      tension: 0.1,
      pointBackgroundColor: 'rgb(75, 192, 192)'
    }]
  };
}

function populateEventSelectForProgression(swimmerId) {
  selectEventForProgression.innerHTML = '<option value="">-- Select an Event --</option>';
  const events = [...new Set(allAthleteData.filter(d => d.id === swimmerId).map(d => normalizeEventName(d.eventSwum)))];
  events.sort().forEach(event => {
    const opt = document.createElement('option');
    opt.value = event;
    opt.textContent = event;
    selectEventForProgression.appendChild(opt);
  });
  selectEventForProgression.disabled = events.length === 0;
}

// === Hook into existing fetchAndRenderData ===
function fetchAndRenderData(filename) {
  // ... (keep all existing logic) ...
  // After setting allAthleteData:
  allAthleteData = applySeasonFilter(allAthleteData);
  populateSeasonFilter([...new Set(allAthleteData.map(d => new Date(d.meetDate).getFullYear()))].sort());
  setupProgressionToggle();
}

// === Save season filter selection ===
document.getElementById('filterSeason').addEventListener('change', (e) => {
  selectedSeason = e.target.value;
  localStorage.setItem('selectedSeason', selectedSeason);
  fetchAndRenderData(jsonFileSelector.value);
});
</script>

<style>
  @media print {
    .no-print {
      display: none !important;
    }
    .print-label {
      font-weight: bold;
      color: #000;
      display: block;
      margin-bottom: 4px;
    }
    .print-value {
      margin-bottom: 10px;
    }
  }
</style>

<!-- Replace this inside your filter container -->
<div class="no-print mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">Report Filters</h2>
  <div class="flex flex-col sm:flex-row sm:items-end gap-4 mb-4">
    <div class="flex-1 min-w-[200px]">
      <label for="jsonFileSelector" class="block text-sm font-medium text-gray-700 mb-1 print-label">Load Results File:</label>
      <select id="jsonFileSelector" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 print-value">
        <!-- JS will populate -->
      </select>
    </div>
    <div class="flex-1 min-w-[150px]">
      <label for="filterName" class="block text-sm font-medium text-gray-700 mb-1 print-label">Filter by Athlete Name:</label>
      <input type="text" id="filterName" placeholder="Enter full name or part" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 print-value">
    </div>
    <div class="flex-1 min-w-[150px]">
      <label for="filterStroke" class="block text-sm font-medium text-gray-700 mb-1 print-label">Filter by Stroke:</label>
      <select id="filterStroke" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 print-value">
        <option value="">All Strokes</option>
        <option value="Freestyle">Freestyle</option>
        <option value="Backstroke">Backstroke</option>
        <option value="Butterfly">Butterfly</option>
        <option value="Breaststroke">Breaststroke</option>
        <option value="IM">IM</option>
      </select>
    </div>
    <div class="flex-1 min-w-[150px]">
      <label for="seasonFilter" class="block text-sm font-medium text-gray-700 mb-1 print-label">Season:</label>
      <select id="seasonFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 print-value">
        <option value="">All Years</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
      </select>
    </div>
    <div class="flex-1 min-w-[150px]">
      <label for="toggleMeetScope" class="block text-sm font-medium text-gray-700 mb-1 print-label">Show:</label>
      <select id="toggleMeetScope" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 print-value">
        <option value="with-times">Only Meets with Results</option>
        <option value="all-meets">All Meets</option>
      </select>
    </div>
    <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
      Apply Filters
    </button>
    <button id="resetFilters" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
      Reset Filters
    </button>
  </div>
</div>

    
</body>
</html>

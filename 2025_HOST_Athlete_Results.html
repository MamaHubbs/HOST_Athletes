<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Meet Summary Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Set default font to Inter */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem; /* Slightly smaller base font */
        }

        /* Basic table styling for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem; /* Smaller table font */
        }

        th, td {
            padding: 8px 12px; /* Reduced padding for smaller font */
            text-align: left;
            /* Applying border only to bottom for data rows, full border for headers */
            border-bottom: 1px solid #e2e8f0; /* Tailwind's gray-200 */
        }

        /* Specific styling for the new athlete header rows */
        .athlete-header-row {
            background-color: #e0e7ff; /* Light blue-200 */
            font-weight: bold;
            font-size: 1em; /* Relative to table font size (0.85rem) */
            color: #1f2937; /* Gray-800 */
            border-top: 2px solid #6366f1; /* Indigo-500 */
            border-bottom: 2px solid #6366f1; /* Indigo-500 */
            text-align: left !important;
        }

        /* Specific styling for the event sub-header rows */
        .event-subheader-row th {
            background-color: #f8fafc; /* Tailwind's gray-50 */
            font-weight: 600;
            color: #4a5568; /* Tailwind's gray-700 */
            padding-left: 20px; /* Reduced indent for sub-headers */
            border-bottom: 1px solid #cbd5e0; /* Gray-300 */
            font-size: 0.8em; /* Even smaller for sub-headers */
        }

        /* Styling for the data rows under events */
        .event-data-row td {
            padding-left: 30px; /* Reduced indent for event data */
            font-size: 0.85em; /* Keep it readable */
        }

        tr:hover {
            background-color: #f0f4f8; /* Lighter hover effect */
        }

        /* Custom styles for printing */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print {
                display: none !important;
            }
            /* Ensure table borders are visible for print */
            table, th, td {
                border-collapse: collapse;
                border: 1px solid #ddd; /* Light gray border */
            }
            /* Override background for printing */
            .bg-gray-100 {
                background-color: #ffffff !important;
            }
            .text-gray-800 {
                color: #000000 !important;
            }
            /* Hide charts on print for cleaner table output, unless explicitly needed */
            .chart-section {
                display: none !important;
            }
            /* Adjust padding for print to avoid cutting off text */
            table th, table td {
                padding: 4px 6px;
                font-size: 0.8em;
            }
            .athlete-header-row {
                background-color: #e0e7ff !important;
                color: #1f2937 !important;
                border-top: 1px solid #6366f1 !important;
                border-bottom: 1px solid #6366f1 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6 sm:p-10 min-h-screen flex flex-col items-center">
    <div class="container mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg max-w-7xl w-full">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 text-center">Athlete Meet Summary Dashboard</h1>

        <!-- Filter Controls - No Print -->
        <div class="no-print mb-6 p-4 bg-blue-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Report Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="filterName" class="block text-sm font-medium text-gray-700 mb-1">Filter by Name:</label>
                    <input type="text" id="filterName" placeholder="Enter full name or part" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="filterCategory" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category:</label>
                    <input type="text" id="filterCategory" placeholder="e.g., Female, Male" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="filterEvent" class="block text-sm font-medium text-gray-700 mb-1">Filter by Event:</label>
                    <input type="text" id="filterEvent" placeholder="e.g., Freestyle, Backstroke" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <!-- New: JSON File Selector and Date Range Filters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="jsonFileSelector" class="block text-sm font-medium text-gray-700 mb-1">Load Results File:</label>
                    <select id="jsonFileSelector" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options populated by JavaScript with date ranges -->
                    </select>
                </div>
                <div>
                    <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date:</label>
                    <input type="date" id="filterStartDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">End Date:</label>
                    <input type="date" id="filterEndDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="applyFilters" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Apply Filters
                </button>
                <button id="resetFilters" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Reset Filters
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="chart-section mt-8 mb-6 p-4 bg-purple-50 rounded-lg shadow-inner no-print">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 text-center">Swimmer Performance Dashboard</h2>

            <div class="mb-6">
                <label for="selectSwimmer" class="block text-lg font-medium text-gray-700 mb-2">Select Swimmer for Charts:</label>
                <select id="selectSwimmer" class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-purple-500 focus:border-purple-500">
                    <option value="">-- Select an Athlete --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                <!-- Specialty Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center h-96">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Swimmer Specialty (Radar Chart)</h3>
                    <canvas id="specialtyChart"></canvas>
                </div>

                <!-- Progression Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center h-96">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Time Progression (Line Chart)</h3>
                    <canvas id="progressionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Print Button - No Print -->
        <div class="no-print flex justify-center mb-6">
            <button id="printReport" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v1a2 2 0 002 2h6a2 2 0 002-2v-1m0 0H7m0 0h10" />
                </svg>
                <span>Print Report</span>
            </button>
        </div>

        <!-- Report Table -->
        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table class="min-w-full bg-white">
                <thead>
                    <!-- This header is just for screen readers/initial structure, actual headers are per athlete -->
                    <tr>
                        <th class="hidden">Athlete Details</th>
                        <th class="hidden">Event</th>
                        <th class="hidden">Seed Time</th>
                        <th class="hidden">Final Time</th>
                        <th class="hidden">Place</th>
                        <th class="hidden">Points</th>
                        <th class="hidden">% Improvement</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Helper function to convert time string (MM:SS.ms or SS.ms) to seconds
        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === 'NT' || timeStr === 'NS' || timeStr === 'DQ') return Infinity; // Added 'NT' for No Time
            const parts = String(timeStr).split(':'); // Ensure timeStr is a string
            if (parts.length === 2) {
                const minutes = parseInt(parts[0]);
                const seconds = parseFloat(parts[1]);
                return minutes * 60 + seconds;
            } else if (parts.length === 1) {
                return parseFloat(parts[0]); // Handles cases like "28.15" if no minutes
            }
            return Infinity; // Invalid format
        }

        // Helper function to convert seconds to time string (MM:SS.ms)
        function secondsToTime(totalSeconds) {
            if (totalSeconds === Infinity || isNaN(totalSeconds)) return 'N/A';
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            // Pad seconds with leading zero if less than 10, and ensure two decimal places
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds.toFixed(2)}`;
        }

        // Helper to format date for display (e.g., "June 8")
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        }

        // Helper to format date with year (e.g., "June 8, 2025")
        function formatDateWithYear(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        // --- Configuration for JSON file paths and weekly file names ---
        const weeklyFileNames = [
            "2025resultsweek01.json",
            "2025resultsweek02.json", // Add your other weekly files here
            "2025resultsweek03.json"
        ];

        // --- Simulated JSON Data (for Canvas preview fallback) ---
        // This object is a fallback for when the actual fetch calls fail (e.g., when viewing the HTML locally
        // without a web server, or if the files are not correctly placed/accessible).
        // For production, you can remove this object entirely.
        const simulatedJsonData = {
            "2025resultsweek01.json": {
                "title": "Megan - HOST Results by Athlete [Draft]",
                "values": [
                    ["Ackerson", "Adam", "M", 13, "13-14 Boys 50m Butterfly", "NT", "41.68", 3, 3.0],
                    ["Ackerson", "Adam", "M", 13, "13-14 Boys 50m Freestyle", "NT", "35.10", 10, 0.0],
                    ["Ackerson", "Mary", "F", 12, "11-12 Girls 50m Freestyle", "NT", "37.73", 2, 4.0],
                    ["Ackerson", "Mary", "F", 12, "12&U Girls 100m Freestyle", "NT", "1:22.24", 2, 4.0],
                    ["Albright", "Reese", "F", 16, "13-18 Girls 100m Freestyle", "NT", "1:18.95", 2, 4.0],
                    ["Albright", "Reese", "F", 16, "15-18 Girls 50m Butterfly", "42.30", "42.81", 2, 4.0],
                    ["Beirne", "Mason", "M", 15, "15-18 Boys 50m Butterfly", "34.37", "32.87", 1, 6.0],
                    ["Beirne", "Mason", "M", 15, "15-18 Boys 50m Freestyle", "31.18", "30.99", 3, 3.0],
                    ["Bell", "Heather", "F", 10, "9-10 Girls 25m Backstroke", "NT", "28.61", 5, 1.0],
                    ["Bell", "Heather", "F", 10, "9-10 Girls 25m Butterfly", "NT", "28.22", 4, 2.0],
                    ["Bell", "Heather", "F", 10, "9-10 Girls 25m Freestyle", "22.68", "21.86", 4, 2.0],
                    ["Bell", "John", "M", 9, "9-10 Boys 25m Backstroke", "NT", "37.06", 8, 0.0],
                    ["Bell", "John", "M", 9, "9-10 Boys 25m Butterfly", "NT", "29.02", 4, 2.0],
                    ["Bell", "John", "M", 9, "9-10 Boys 25m Freestyle", "28.98", "24.90", 11, 0.0],
                    ["Bell", "Liliana", "F", 12, "11-12 Girls 50m Freestyle", "NT", "56.75", 15, 0.0],
                    ["Berger", "Beau", "M", 6, "6&U Boys 25m Backstroke", "NT", "1:43.61", 2, 4.0],
                    ["Berger", "Beau", "M", 6, "6&U Boys 25m Freestyle", "NT", "1:14.03", 2, 4.0],
                    ["Berger", "Huck", "M", 9, "9-10 Boys 25m Freestyle", "29.84", "26.37", 12, 0.0],
                    ["Berger", "Mae", "F", 8, "7-8 Girls 25m Freestyle", "55.46", "45.92", 8, 0.0],
                    ["Cantwell", "Chelsea", "F", 14, "13-14 Girls 50m Freestyle", "40.28", "41.34", 12, 0.0],
                    ["Cantwell", "Reagan", "F", 11, "11-12 Girls 50m Backstroke", "NT", "1:27.38", 7, 0.0],
                    ["Cantwell", "Reagan", "F", 11, "11-12 Girls 50m Freestyle", "50.60", "53.94", 14, 0.0],
                    ["Carlson", "Claire", "F", 7, "7-8 Girls 25m Backstroke", "54.43", "42.66", 5, 1.0],
                    ["Carlson", "Claire", "F", 7, "7-8 Girls 25m Freestyle", "47.68", "50.75", 9, 0.0],
                    ["Carlson", "Theresa", "F", 10, "9-10 Girls 25m Backstroke", "NT", "27.79", 3, 3.0],
                    ["Carlson", "Theresa", "F", 10, "9-10 Girls 25m Butterfly", "NT", "26.92", 2, 4.0],
                    ["Carlson", "Theresa", "F", 10, "9-10 Girls 25m Freestyle", "22.29", "23.73", 5, 1.0],
                    ["Cassavella", "Carla", "F", 10, "9-10 Girls 25m Freestyle", "NT", "33.43", 14, 0.0],
                    ["Cassavella", "Dominick", "M", 8, "7-8 Boys 25m Freestyle", "NT", "29.49", 5, 0.0],
                    ["Christianson", "Charles", "M", 9, "9-10 Boys 25m Freestyle", "NT", "36.44", 16, 0.0],
                    ["Christianson", "Matthew", "M", 15, "15-18 Boys 50m Backstroke", "NT", "39.80", 2, 4.0],
                    ["Christianson", "Matthew", "M", 15, "15-18 Boys 50m Freestyle", "NT", "32.97", 6, 0.0],
                    ["Christianson", "Ryan", "M", 12, "11-12 Boys 50m Freestyle", "46.00", "45.60", 3, 3.0],
                    ["Christianson", "Ryan", "M", 12, "12&U Boys 100m Freestyle", "NT", "1:43.16", 5, 1.0],
                    ["Cooper", "Dalton", "M", 10, "9-10 Boys 25m Freestyle", "NT", "18.37", 1, 6.0],
                    ["Cooper", "Jason", "M", 13, "13-14 Boys 50m Backstroke", "NT", "40.41", 4, 2.0],
                    ["Cooper", "Jason", "M", 13, "13-14 Boys 50m Freestyle", "NT", "30.90", 4, 0.0],
                    ["Crook", "Jocelyn", "F", 14, "13-14 Girls 50m Freestyle", "36.86", "38.09", 7, 0.0],
                    ["Daniels", "Ethen", "M", 11, "11-12 Boys 50m Butterfly", "38.82", "41.01", 2, 4.0],
                    ["Daniels", "Ethen", "M", 11, "12&U Boys 100m Freestyle", "NT", "1:15.54", 2, 4.0],
                    ["Douglas", "Brechan", "M", 14, "13-14 Boys 50m Backstroke", "35.03", "34.06", 3, 3.0],
                    ["Douglas", "Brechan", "M", 14, "13-14 Boys 50m Freestyle", "29.92", "29.71", 1, 6.0],
                    ["Douglas", "Maezy", "F", 11, "11-12 Girls 50m Backstroke", "NT", "54.13", 2, 4.0],
                    ["Douglas", "Maezy", "F", 11, "11-12 Girls 50m Freestyle", "42.97", "44.43", 8, 0.0],
                    ["Elliott", "Matthew", "M", 18, "15-18 Boys 50m Backstroke", "NT", "37.62", 1, 6.0],
                    ["Elliott", "Matthew", "M", 18, "15-18 Boys 50m Butterfly", "35.68", "34.53", 2, 4.0],
                    ["Fenton", "Jillian", "F", 14, "13-14 Girls 50m Freestyle", "NT", "40.76", 11, 0.0],
                    ["Fenton", "Jillian", "F", 14, "13-18 Girls 100m Freestyle", "NT", "1:26.00", 5, 1.0],
                    ["Fenton", "Phoebe", "F", 12, "11-12 Girls 50m Freestyle", "NT", "40.29", 5, 1.0],
                    ["Fenton", "Phoebe", "F", 12, "12&U Girls 100m Freestyle", "NT", "1:34.13", 4, 0.0],
                    ["Fenton", "Scarlett", "F", 15, "15-18 Girls 50m Backstroke", "51.85", "48.17", 2, 4.0],
                    ["Fenton", "Scarlett", "F", 15, "15-18 Girls 50m Freestyle", "38.05", "36.18", 1, 6.0],
                    ["Francis", "Sanaa", "F", 10, "9-10 Girls 25m Backstroke", "24.70", "27.89", 4, 2.0],
                    ["Francis", "Sanaa", "F", 10, "9-10 Girls 25m Freestyle", "19.84", "19.78", 3, 3.0],
                    ["Garcia", "Ryan", "M", 14, "13-14 Boys 50m Butterfly", "33.28", "32.63", 2, 4.0],
                    ["Garcia", "Ryan", "M", 14, "13-18 Boys 100m Freestyle", "NT", "1:05.46", 3, 3.0],
                    ["Gianakas", "Alexander", "M", 6, "6&U Boys 25m Backstroke", "NT", "58.32", 1, 6.0],
                    ["Gianakas", "Alexander", "M", 6, "6&U Boys 25m Freestyle", "1:06.45", "1:01.63", 1, 6.0],
                    ["Gianakas", "Benjamin", "M", 8, "7-8 Boys 25m Backstroke", "30.04", "31.32", 2, 4.0],
                    ["Gianakas", "Benjamin", "M", 8, "7-8 Boys 25m Freestyle", "25.65", "25.16", 3, 3.0],
                    ["Goetsch", "Colton", "M", 11, "11-12 Boys 50m Freestyle", "45.46", "46.88", 5, 0.0],
                    ["Goetsch", "Denver", "M", 9, "9-10 Boys 25m Freestyle", "27.33", "21.84", 6, 0.0],
                    ["Goetsch", "Mason", "M", 13, "13-14 Boys 50m Freestyle", "31.35", "30.89", 3, 3.0],
                    ["Green", "Christian", "M", 12, "11-12 Boys 50m Butterfly", "39.19", "37.49", 1, 6.0],
                    ["Green", "Christian", "M", 12, "12&U Boys 100m Freestyle", "NT", "1:13.25", 1, 6.0],
                    ["Green", "Hudson", "M", 15, "13-18 Boys 100m Freestyle", "NT", "1:13.24", 7, 0.0],
                    ["Green", "Madison", "F", 14, "13-14 Girls 50m Backstroke", "52.38", "51.36", 5, 0.0],
                    ["Green", "Madison", "F", 14, "13-14 Girls 50m Freestyle", "39.89", "38.91", 8, 0.0],
                    ["Green", "Tenley", "F", 13, "13-14 Girls 50m Freestyle", "NT", "46.41", 16, 0.0],
                    ["Haight", "Owen", "M", 14, "13-14 Boys 50m Freestyle", "NT", "35.29", 12, 0.0],
                    ["Hall", "Cayson", "M", 9, "9-10 Boys 25m Freestyle", "NT", "47.48", 18, 0.0],
                    ["Hall", "Christopher", "M", 15, "13-18 Boys 100m Freestyle", "NT", "1:22.44", 9, 0.0],
                    ["Hall", "Christopher", "M", 15, "15-18 Boys 50m Freestyle", "36.47", "37.19", 11, 0.0],
                    ["Hall", "Lincoln", "M", 12, "11-12 Boys 50m Freestyle", "42.99", "41.86", 2, 4.0],
                    ["Hall", "Lincoln", "M", 12, "12&U Boys 100m Freestyle", "NT", "1:35.21", 4, 2.0],
                    ["Hoole", "Andrew", "M", 9, "9-10 Boys 25m Freestyle", "54.75", "47.25", 17, 0.0],
                    ["Hoole", "David", "M", 12, "11-12 Boys 50m Freestyle", "NT", "46.81", 4, 0.0],
                    ["Jackson", "Austin", "M", 8, "7-8 Boys 25m Freestyle", "22.10", "21.69", 1, 6.0],
                    ["Jackson", "Austin", "M", 8, "8&U Boys 25m Butterfly", "34.01", "37.77", 1, 6.0],
                    ["Jackson", "Connor", "M", 13, "13-14 Boys 50m Freestyle", "NT", "32.45", 5, 0.0],
                    ["Jackson", "Dillon", "M", 15, "13-18 Boys 100m Freestyle", "NT", "1:18.23", 8, 0.0],
                    ["Jackson", "Dillon", "M", 15, "15-18 Boys 50m Butterfly", "NT", "46.11", 5, 1.0],
                    ["Jackson", "Dillon", "M", 15, "15-18 Boys 50m Freestyle", "NT", "34.71", 7, 0.0],
                    ["Jackson", "Everett", "M", 11, "11-12 Boys 50m Butterfly", "NT", "1:03.29", 4, 2.0],
                    ["Jackson", "Everett", "M", 11, "12&U Boys 100m Freestyle", "NT", "1:52.80", 6, 0.0],
                    ["Kerr", "Mirabel", "F", 6, "6&U Girls 25m Backstroke", "NT", "37.12", 3, 3.0],
                    ["Kerr", "Mirabel", "F", 6, "6&U Girls 25m Freestyle", "45.01", "39.81", 3, 3.0],
                    ["Kerr", "Thomas", "M", 10, "9-10 Boys 25m Backstroke", "23.84", "24.42", 2, 4.0],
                    ["Kerr", "Thomas", "M", 10, "9-10 Boys 25m Butterfly", "NT", "34.75", 6, 0.0],
                    ["Kerr", "Thomas", "M", 10, "9-10 Boys 25m Freestyle", "20.88", "20.37", 5, 1.0],
                    ["Kress", "Ava", "F", 16, "15-18 Girls 50m Butterfly", "NT", "54.91", 4, 2.0],
                    ["Kress", "Ava", "F", 16, "15-18 Girls 50m Freestyle", "43.94", "44.91", 4, 2.0],
                    ["Kress", "Connor", "M", 14, "13-14 Boys 50m Freestyle", "31.07", "30.25", 2, 4.0],
                    ["Kruk", "Caiden", "M", 9, "9-10 Boys 25m Backstroke", "31.58", "31.17", 5, 0.0],
                    ["Kruk", "Caiden", "M", 9, "9-10 Boys 25m Freestyle", "19.96", "19.43", 4, 2.0],
                    ["Kruk", "Madison", "F", 8, "7-8 Girls 25m Freestyle", "31.30", "36.02", 6, 0.0],
                    ["Kuhfuss", "Brooke", "F", 9, "9-10 Girls 25m Backstroke", "35.36", "35.25", 7, 0.0],
                    ["Kuhfuss", "Brooke", "F", 9, "9-10 Girls 25m Butterfly", "NT", "31.53", 5, 1.0],
                    ["Kuhfuss", "Brooke", "F", 9, "9-10 Girls 25m Freestyle", "26.47", "27.10", 9, 0.0],
                    ["Kuhfuss", "Jacquelyn", "F", 7, "7-8 Girls 25m Backstroke", "46.03", "43.22", 6, 0.0],
                    ["Kuhfuss", "Jacquelyn", "F", 7, "7-8 Girls 25m Freestyle", "36.20", "34.84", 4, 2.0],
                    ["Lewis", "Zoey", "F", 7, "7-8 Girls 25m Freestyle", "NT", "56.67", 10, 0.0],
                    ["Lopez", "Dominik", "M", 13, "13-14 Boys 50m Butterfly", "NT", "52.81", 5, 1.0],
                    ["Lopez", "Dominik", "M", 13, "13-14 Boys 50m Freestyle", "NT", "35.17", 11, 0.0],
                    ["Maynard", "Brooke", "F", 12, "11-12 Girls 50m Butterfly", "NT", "52.27", 3, 3.0],
                    ["Maynard", "Brooke", "F", 12, "11-12 Girls 50m Freestyle", "NT", "40.17", 4, 2.0],
                    ["McGhee", "Elizabeth", "F", 14, "13-14 Girls 50m Freestyle", "NT", "45.56", 15, 0.0],
                    ["McGowan", "James", "M", 7, "7-8 Boys 25m Backstroke", "35.08", "33.43", 3, 3.0],
                    ["McGowan", "James", "M", 7, "7-8 Boys 25m Freestyle", "35.85", "35.99", 6, 0.0],
                    ["McIntyre", "Bryan", "M", 8, "7-8 Boys 25m Backstroke", "28.90", "29.97", 1, 6.0],
                    ["McIntyre", "Bryan", "M", 8, "7-8 Boys 25m Freestyle", "22.62", "23.35", 2, 4.0],
                    ["McIntyre", "Elliana", "F", 11, "12&U Girls 100m Freestyle", "NT", "1:33.44", 3, 3.0],
                    ["Miller", "Eden", "F", 13, "13-14 Girls 50m Backstroke", "NT", "39.12", 2, 4.0],
                    ["Miller", "Eden", "F", 13, "13-14 Girls 50m Freestyle", "NT", "32.90", 3, 3.0],
                    ["Monge", "Victoria", "F", 12, "11-12 Girls 50m Butterfly", "NT", "1:00.77", 4, 2.0],
                    ["Monge", "Victoria", "F", 12, "12&U Girls 100m Freestyle", "NT", "1:39.69", 6, 0.0],
                    ["Moore", "Theo", "M", 7, "7-8 Boys 25m Freestyle", "NT", "36.92", 7, 0.0],
                    ["Morales", "Katherine", "F", 12, "11-12 Girls 50m Backstroke", "NT", "55.29", 3, 3.0],
                    ["Morales", "Katherine", "F", 12, "12&U Girls 100m Freestyle", "NT", "1:36.91", 5, 0.0],
                    ["Morales", "Madelyn", "F", 14, "13-14 Girls 50m Butterfly", "NT", "40.71", 2, 4.0],
                    ["Morales", "Madelyn", "F", 14, "13-14 Girls 50m Freestyle", "NT", "35.46", 4, 0.0],
                    ["Mulder", "Asher", "M", 13, "13-14 Boys 50m Freestyle", "42.45", "39.91", 14, 0.0],
                    ["Mulder", "Nora", "F", 16, "13-18 Girls 100m Freestyle", "NT", "1:28.77", 6, 0.0],
                    ["Mulder", "Nora", "F", 16, "15-18 Girls 50m Backstroke", "NT", "50.51", 4, 2.0],
                    ["Mulder", "Tori", "F", 11, "11-12 Girls 50m Butterfly", "NT", "1:05.50", 6, 0.0],
                    ["Mulder", "Tori", "F", 11, "11-12 Girls 50m Freestyle", "53.31", "49.63", 13, 0.0],
                    ["Nelson", "Genevieve", "F", 12, "11-12 Girls 50m Freestyle", "NT", "42.66", 6, 0.0],
                    ["Orrison", "Carter", "M", 12, "11-12 Boys 50m Freestyle", "53.29", "50.19", 6, 0.0],
                    ["Orrison", "Grayson", "M", 8, "7-8 Boys 25m Freestyle", "44.07", "40.32", 8, 0.0],
                    ["Parker", "Emmalyn", "F", 6, "6&U Girls 25m Backstroke", "NT", "32.69", 2, 4.0],
                    ["Parker", "Emmalyn", "F", 6, "6&U Girls 25m Freestyle", "NT", "35.87", 2, 4.0],
                    ["Parker", "William", "M", 9, "9-10 Boys 25m Backstroke", "NT", "27.91", 4, 0.0],
                    ["Parker", "William", "M", 9, "9-10 Boys 25m Butterfly", "NT", "28.05", 3, 3.0],
                    ["Parker", "William", "M", 9, "9-10 Boys 25m Freestyle", "NT", "22.30", 8, 0.0],
                    ["Pattillo", "Jackson", "M", 12, "11-12 Boys 50m Backstroke", "NT", "1:34.80", 3, 3.0],
                    ["Pattillo", "Jackson", "M", 12, "11-12 Boys 50m Freestyle", "NT", "1:04.04", 8, 0.0],
                    ["Paxton", "Laila", "F", 14, "13-14 Girls 50m Freestyle", "NT", "35.51", 5, 0.0],
                    ["Phillips", "Hayleigh", "F", 9, "9-10 Girls 25m Freestyle", "32.03", "30.55", 12, 0.0],
                    ["Powell", "Sean", "M", 8, "7-8 Boys 25m Freestyle", "NT", "41.46", 9, 0.0],
                    ["Rattray", "Elisia", "F", 12, "11-12 Girls 50m Backstroke", "NT", "52.02", 1, 6.0],
                    ["Rattray", "Elisia", "F", 12, "11-12 Girls 50m Butterfly", "52.78", "48.18", 1, 6.0],
                    ["Rattray", "John", "M", 12, "11-12 Boys 50m Freestyle", "41.53", "41.38", 1, 6.0],
                    ["Rattray", "Mara", "F", 8, "7-8 Girls 25m Backstroke", "31.21", "30.15", 1, 6.0],
                    ["Rattray", "Mara", "F", 8, "7-8 Girls 25m Freestyle", "29.82", "30.11", 2, 4.0],
                    ["Roussos", "Ava", "F", 14, "13-14 Girls 50m Butterfly", "NT", "51.51", 4, 2.0],
                    ["Roussos", "Ava", "F", 14, "13-18 Girls 100m Freestyle", "NT", "1:33.59", 7, 0.0],
                    ["Stewart", "Ava", "F", 13, "13-14 Girls 50m Butterfly", "NT", "44.30", 3, 3.0],
                    ["Stewart", "Ava", "F", 13, "13-14 Girls 50m Freestyle", "40.11", "39.98", 10, 0.0],
                    ["Strait", "Abel", "M", 10, "9-10 Boys 25m Backstroke", "NT", "25.47", 3, 3.0],
                    ["Strait", "Abel", "M", 10, "9-10 Boys 25m Freestyle", "NT", "22.37", 9, 0.0],
                    ["Troidl", "Dylan", "M", 13, "13-14 Boys 50m Freestyle", "NT", "33.29", 7, 0.0],
                    ["Troidl", "Michael", "M", 17, "13-18 Boys 100m Freestyle", "NT", "1:05.80", 4, 2.0],
                    ["Troidl", "Michael", "M", 17, "15-18 Boys 50m Freestyle", "NT", "29.74", 1, 6.0],
                    ["Whitis", "Elijah", "M", 14, "13-14 Boys 50m Freestyle", "34.57", "32.59", 6, 0.0],
                    ["Whitis", "Finneas", "M", 13, "13-14 Boys 50m Backstroke", "33.26", "33.08", 2, 4.0],
                    ["Whitis", "Finneas", "M", 13, "13-18 Boys 100m Freestyle", "NT", "1:05.22", 2, 4.0],
                    ["Whitis", "Gradie", "F", 9, "9-10 Girls 25m Butterfly", "NT", "25.18", 1, 6.0],
                    ["Whitis", "Gradie", "F", 9, "9-10 Girls 25m Freestyle", "19.28", "19.61", 2, 4.0],
                    ["Whitis", "Willa", "F", 7, "7-8 Girls 25m Backstroke", "33.07", "38.31", 3, 3.0],
                    ["Whitis", "Willa", "F", 7, "7-8 Girls 25m Freestyle", "30.66", "32.58", 3, 3.0],
                    ["Wittwer", "Benjamin", "M", 15, "15-18 Boys 50m Backstroke", "NT", "44.63", 4, 2.0],
                    ["Wittwer", "Benjamin", "M", 15, "15-18 Boys 50m Freestyle", "NT", "36.40", 8, 0.0],
                    ["Wittwer", "Eleanor", "F", 9, "9-10 Girls 25m Freestyle", "30.80", "27.29", 10, 0.0],
                    ["Wittwer", "Elizabeth", "F", 12, "11-12 Girls 50m Freestyle", "NT", "44.36", 7, 0.0],
                    ["Woodruff", "Ally", "F", 12, "11-12 Girls 50m Freestyle", "32.26", "33.15", 1, 6.0],
                    ["Woodruff", "Ally", "F", 12, "12&U Girls 100m Freestyle", "NT", "1:15.71", 1, 6.0],
                    ["Woodruff", "Jaden", "M", 9, "9-10 Boys 25m Freestyle", "28.70", "35.34", 15, 0.0],
                    ["Woodruff", "Jamela", "F", 13, "13-14 Girls 50m Backstroke", "NT", "41.26", 3, 3.0],
                    ["Woodruff", "Jamela", "F", 13, "13-14 Girls 50m Freestyle", "33.03", "32.62", 2, 4.0],
                    ["Woodruff", "Kyra", "F", 16, "13-18 Girls 100m Freestyle", "NT", "1:10.84", 1, 6.0],
                    ["Woodruff", "Kyra", "F", 16, "15-18 Girls 50m Butterfly", "37.59", "37.06", 1, 6.0],
                    ["Woodruff", "Leo", "M", 9, "9-10 Boys 25m Butterfly", "NT", "31.46", 5, 1.0],
                    ["Woodruff", "Leo", "M", 9, "9-10 Boys 25m Freestyle", "20.31", "22.14", 7, 0.0],
                    ["Woodruff", "Manion", "M", 13, "13-14 Boys 50m Freestyle", "35.14", "34.49", 8, 0.0],
                    ["Woodruff", "Mia", "F", 14, "13-14 Girls 50m Backstroke", "38.09", "36.40", 1, 6.0],
                    ["Woodruff", "Mia", "F", 14, "13-14 Girls 50m Freestyle", "32.64", "31.73", 1, 6.0],
                    ["Woodruff", "Owen", "M", 9, "9-10 Boys 25m Backstroke", "NT", "23.15", 1, 6.0],
                    ["Woodruff", "Owen", "M", 9, "9-10 Boys 25m Butterfly", "24.80", "23.66", 1, 6.0],
                    ["Woodruff", "Owen", "M", 9, "9-10 Boys 25m Freestyle", "19.62", "19.24", 3, 3.0],
                    ["Zirkle", "Kyrie", "F", 10, "9-10 Girls 25m Freestyle", "23.51", "23.98", 6, 0.0]
                ],
                "fields": ["last_name", "first_name", "competition_category", "age", "event_swum", "seed_time", "result_time", "place", "points"],
                "types": [25, 25, 25, 23, 25, 25, 25, 23, 701],
                "type_names": ["text", "text", "text", "integer", "text", "text", "text", "integer", "float"],
                "started_at": "2025-06-08 12:00:00 +0000", // Example date for week 01
                "finished_at": "2025-06-08 15:00:00 +0000",
                "checksum": "4e67cac98c8a873f4102ce29f43dc390"
            },
            "2025resultsweek02.json": { // Added simulated data for week 02 to demonstrate
                "title": "Megan - HOST Results by Athlete [Draft] Week 02",
                "values": [
                    ["Smith", "Alice", "F", 14, "100m Freestyle", "1:01.00", "1:00.50", 1, 50],
                    ["Johnson", "Bob", "M", 22, "50m Backstroke", "0:27.50", "0:27.20", 1, 60],
                    ["Williams", "Charlie", "M", 15, "200m IM", "2:34.00", "2:33.00", 3, 30],
                    ["Hubbard", "Zachary", "M", 18, "50m Breaststroke", "0:31.00", "0:30.50", 1, 9]
                ],
                "fields": ["last_name", "first_name", "competition_category", "age", "event_swum", "seed_time", "result_time", "place", "points"],
                "types": [25, 25, 25, 23, 25, 25, 25, 23, 701],
                "type_names": ["text", "text", "text", "integer", "text", "text", "text", "integer", "float"],
                "started_at": "2025-06-15 12:00:00 +0000",
                "finished_at": "2025-06-15 15:00:00 +0000",
                "checksum": "mock_checksum_week02"
            },
            "2025resultsweek03.json": { // Added simulated data for week 03 to demonstrate
                "title": "Megan - HOST Results by Athlete [Draft] Week 03",
                "values": [
                    ["Smith", "Alice", "F", 15, "50m Freestyle", "0:26.50", "0:26.20", 1, 55],
                    ["Johnson", "Bob", "M", 22, "200m Backstroke", "2:10.00", "2:09.50", 1, 65]
                ],
                "fields": ["last_name", "first_name", "competition_category", "age", "event_swum", "seed_time", "result_time", "place", "points"],
                "types": [25, 25, 25, 23, 25, 25, 25, 23, 701],
                "type_names": ["text", "text", "text", "integer", "text", "text", "text", "integer", "float"],
                "started_at": "2025-06-22 12:00:00 +0000",
                "finished_at": "2025-06-22 15:00:00 +0000",
                "checksum": "mock_checksum_week03"
            }
        };
        // --- End Simulated JSON Data ---

        let allAthleteData = []; // This will now be populated dynamically
        let filteredAthleteData = [];

        const reportTableBody = document.getElementById('reportTableBody');
        const filterNameInput = document.getElementById('filterName');
        const filterCategoryInput = document.getElementById('filterCategory');
        const filterEventInput = document.getElementById('filterEvent');
        const filterStartDateInput = document.getElementById('filterStartDate');
        const filterEndDateInput = document.getElementById('filterEndDate');
        const applyFiltersButton = document.getElementById('applyFilters');
        const resetFiltersButton = document.getElementById('resetFilters');
        const printReportButton = document.getElementById('printReport');
        const selectSwimmer = document.getElementById('selectSwimmer');
        const jsonFileSelector = document.getElementById('jsonFileSelector');

        let specialtyChartInstance = null;
        let progressionChartInstance = null;

        /**
         * Transforms raw data from the JSON "values" array into an array of objects
         * with meaningful property names and adds an 'id' and 'meetDate'.
         * @param {Array<Array>} rawValues - The "values" array from the JSON.
         * @param {Array<string>} fieldNames - The "fields" array from the JSON.
         * @param {string} meetDateString - The meet date to assign to all records from this file.
         * @returns {Array<Object>} Transformed athlete data.
         */
        function transformRawData(rawValues, fieldNames, meetDateString) {
            const transformed = [];
            // Assuming the `fields` array corresponds directly to the order in `values`
            const lastNameIndex = fieldNames.indexOf('last_name');
            const firstNameIndex = fieldNames.indexOf('first_name');
            const genderIndex = fieldNames.indexOf('competition_category'); // This is 'gender'
            const ageIndex = fieldNames.indexOf('age');
            const eventSwumIndex = fieldNames.indexOf('event_swum');
            const seedTimeIndex = fieldNames.indexOf('seed_time');
            const resultTimeIndex = fieldNames.indexOf('result_time');
            const placeIndex = fieldNames.indexOf('place');
            const pointsIndex = fieldNames.indexOf('points');

            rawValues.forEach((row, index) => {
                // Generate a simple ID for the athlete (not globally unique, but unique within this dataset)
                // A more robust ID would come from a database.
                const athleteId = `${row[lastNameIndex]}-${row[firstNameIndex]}-${row[ageIndex]}`;
                
                transformed.push({
                    id: athleteId, // Generated ID
                    lastName: row[lastNameIndex],
                    firstName: row[firstNameIndex],
                    category: row[genderIndex], // Renamed to category in JS for consistency with display
                    age: row[ageIndex],
                    eventSwum: row[eventSwumIndex],
                    seedTime: String(row[seedTimeIndex]), // Ensure it's a string for timeToSeconds
                    resultTime: String(row[resultTimeIndex]), // Ensure it's a string for timeToSeconds
                    meetDate: meetDateString.split(' ')[0], // Extract just the date part (e.g., "YYYY-MM-DD")
                    place: row[placeIndex],
                    points: row[pointsIndex]
                });
            });
            return transformed;
        }

        /**
         * Populates the JSON file selector with options including date ranges.
         */
        function populateJsonFileSelector() {
            // Clear existing options
            jsonFileSelector.innerHTML = '';

            const optionsPromises = weeklyFileNames.map(async (fileName, index) => {
                // You were correct to use `new URL(fileName, window.location.href).toString();` for robustness.
                const filePath = new URL(fileName, window.location.href).toString();
                let rawFileData = null; // Will store the raw object from the JSON file

                try {
                    const response = await fetch(filePath);
                    if (!response.ok) {
                        console.warn(`Could not fetch ${filePath}. Falling back to simulated data for dropdown option.`);
                        rawFileData = simulatedJsonData[fileName];
                        if (!rawFileData) {
                             console.warn(`No simulated data for ${fileName} either. Option will be skipped.`);
                             return null;
                        }
                    } else {
                        rawFileData = await response.json();
                    }
                } catch (error) {
                    console.error(`Error fetching ${filePath} for dropdown options:`, error);
                    rawFileData = simulatedJsonData[fileName]; // Fallback
                    if (!rawFileData) {
                         console.warn(`No simulated data for ${fileName} either. Option will be skipped.`);
                         return null;
                    }
                }

                // Ensure rawFileData and its properties exist before proceeding
                if (rawFileData && rawFileData.values && rawFileData.values.length > 0) {
                    // Use the 'started_at' from the JSON file as the single meet date for this file's data
                    const meetDateFromFile = rawFileData.started_at ? rawFileData.started_at.split(' ')[0] : 'UNKNOWN_DATE';
                    
                    const option = document.createElement('option');
                    option.value = fileName;
                    // Format: Week #1 (Jun 8 - Jun 13, 2025)
                    // The date range here is an approximation; ideally, you'd calculate it from data or metadata
                    const startOfMonth = new Date(meetDateFromFile);
                    const endOfWeek = new Date(startOfMonth);
                    endOfWeek.setDate(startOfMonth.getDate() + 5); // Assuming 5 days after start for the range
                    
                    option.textContent = `Week #${index + 1} (${formatDate(startOfMonth.toISOString().split('T')[0])} - ${formatDate(endOfWeek.toISOString().split('T')[0])}, ${new Date(meetDateFromFile).getFullYear()})`;
                    return option;
                }
                return null; // Return null for invalid data or empty values
            });

            Promise.all(optionsPromises).then(options => {
                options.filter(Boolean).forEach(option => jsonFileSelector.appendChild(option)); // Add valid options

                // Add the "All Results" option last
                const allResultsOption = document.createElement('option');
                allResultsOption.value = "all-results";
                allResultsOption.textContent = "All Results (All Weeks)";
                jsonFileSelector.appendChild(allResultsOption);

                // Set default selected file after all options are populated
                jsonFileSelector.value = "2025resultsweek01.json";
            });
        }

        /**
         * Fetches data from JSON file(s) and updates the report.
         * @param {string} fileName - The name of the JSON file to load, or "all-results".
         */
        async function fetchAndRenderData(fileName) {
            let dataToProcess = null; // This will be the raw JSON object (with .values, .fields, etc.)

            if (fileName !== "all-results") {
                const filePath = new URL(fileName, window.location.href).toString();
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) {
                        console.warn(`Could not fetch ${filePath}. Using simulated data instead.`);
                        dataToProcess = simulatedJsonData[fileName];
                        if (!dataToProcess) throw new Error(`No simulated data available for ${fileName}`);
                    } else {
                        dataToProcess = await response.json();
                    }
                } catch (error) {
                    console.error(`Error fetching ${filePath}:`, error);
                    console.warn(`Falling back to simulated data for ${fileName} due to network error.`);
                    dataToProcess = simulatedJsonData[fileName];
                    if (!dataToProcess) {
                         console.error(`No simulated data available for ${fileName} after network error.`);
                         allAthleteData = []; // Ensure data is empty if all else fails
                         return; // Exit if no data can be retrieved
                    }
                }
                
                // Transform the single week's data
                allAthleteData = transformRawData(dataToProcess.values, dataToProcess.fields, dataToProcess.started_at);

            } else {
                // Fetch all files if "all-results" is selected
                const allFetchedRawDataPromises = weeklyFileNames.map(async (name) => {
                    const filePath = new URL(name, window.location.href).toString();
                    let rawFileData = null;
                    try {
                        const response = await fetch(filePath);
                        if (!response.ok) {
                            console.warn(`Could not fetch ${filePath}. Using simulated data for this week.`);
                            rawFileData = simulatedJsonData[name];
                            if (!rawFileData) return []; // Return empty array if no simulated data
                        } else {
                            rawFileData = await response.json();
                        }
                    } catch (error) {
                        console.error(`Error fetching ${filePath}:`, error);
                        console.warn(`Falling back to simulated data for ${name} due to network error.`);
                        rawFileData = simulatedJsonData[name]; // Fallback
                        if (!rawFileData) return [];
                    }
                    // Transform each week's data and include the meet date from its 'started_at'
                    if (rawFileData && rawFileData.values && rawFileData.fields && rawFileData.started_at) {
                         return transformRawData(rawFileData.values, rawFileData.fields, rawFileData.started_at);
                    }
                    return [];
                });

                const allWeeksTransformedData = await Promise.all(allFetchedRawDataPromises);
                allAthleteData = allWeeksTransformedData.flat(); // Flatten the array of arrays into a single array
            }


            if (allAthleteData && allAthleteData.length > 0) {
                applyFilters(); // Apply current filters (including date filters) after new data loads
                populateSwimmerSelect(); // Repopulate swimmer select based on new data
                // Clear and update charts if a swimmer was previously selected
                if (selectSwimmer.value) {
                    updateSpecialtyChart(selectSwimmer.value);
                    updateProgressionChart(selectSwimmer.value);
                } else {
                    // Clear charts if no swimmer selected
                    if (specialtyChartInstance) specialtyChartInstance.destroy();
                    if (progressionChartInstance) progressionChartInstance.destroy();
                }
            } else {
                console.warn(`No data loaded for ${fileName} after transformation.`);
                filteredAthleteData = [];
                renderTable(filteredAthleteData);
                populateSwimmerSelect();
                if (specialtyChartInstance) specialtyChartInstance.destroy();
                if (progressionChartInstance) progressionChartInstance.destroy();
            }
        }

        /**
         * Renders the athlete data into the table, grouped by athlete.
         * @param {Array<Object>} data - The array of athlete data to render.
         */
        function renderTable(data) {
            reportTableBody.innerHTML = ''; // Clear existing rows

            // Group data by athlete
            const athletesGrouped = data.reduce((acc, current) => {
                // Using a combination of id and meetDate for a more robust key if an athlete swims multiple times
                const athleteIdAndName = `${current.lastName}, ${current.firstName} (${current.age}) - ${current.category}`;
                
                // Group by athlete, but keep events distinct
                if (!acc[athleteIdAndName]) {
                    acc[athleteIdAndName] = {
                        id: current.id, // Keep original ID for chart selection
                        details: {
                            lastName: current.lastName,
                            firstName: current.firstName,
                            age: current.age,
                            category: current.category // This is 'gender' from SQL
                        },
                        events: []
                    };
                }
                acc[athleteIdAndName].events.push(current);
                return acc;
            }, {});

            const athleteKeys = Object.keys(athletesGrouped).sort(); // Sort athletes alphabetically

            if (athleteKeys.length === 0) {
                const noResultsRow = document.createElement('tr');
                // Colspan needs to be adjusted based on the new total columns (6 for events + 1 for main header)
                noResultsRow.innerHTML = `
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        No results found matching your filters.
                    </td>
                `;
                reportTableBody.appendChild(noResultsRow);
                return;
            }

            athleteKeys.forEach(athleteKey => {
                const athlete = athletesGrouped[athleteKey];

                // Athlete Header Row
                const athleteHeaderRow = document.createElement('tr');
                athleteHeaderRow.className = 'athlete-header-row';
                athleteHeaderRow.innerHTML = `
                    <td colspan="7" class="px-6 py-3">${athlete.details.lastName}, ${athlete.details.firstName} (${athlete.details.age}) - ${athlete.details.category}</td>
                `;
                reportTableBody.appendChild(athleteHeaderRow);

                // Event Sub-Header Row
                const eventSubHeaderRow = document.createElement('tr');
                eventSubHeaderRow.className = 'event-subheader-row';
                eventSubHeaderRow.innerHTML = `
                    <th>Event</th>
                    <th>Seed</th>
                    <th>Final</th>
                    <th>Place</th>
                    <th>Points</th>
                    <th>% Improvement</th>
                `;
                // Add an empty th to align with the first column of the athlete header
                const emptyTh = document.createElement('th');
                emptyTh.style.width = '1%'; // Small width to avoid large gap
                eventSubHeaderRow.prepend(emptyTh);
                reportTableBody.appendChild(eventSubHeaderRow);

                // Sort events by meetDate and then eventSwum
                athlete.events.sort((a, b) => {
                    const dateA = new Date(a.meetDate);
                    const dateB = new Date(b.meetDate);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA - dateB;
                    }
                    return a.eventSwum.localeCompare(b.eventSwum);
                });

                // Event Data Rows
                athlete.events.forEach(eventData => {
                    const seedSeconds = timeToSeconds(eventData.seedTime);
                    const resultSeconds = timeToSeconds(eventData.resultTime);

                    let improvement = 'N/A';
                    if (seedSeconds !== Infinity && resultSeconds !== Infinity && seedSeconds > 0) {
                        improvement = (((seedSeconds - resultSeconds) / seedSeconds) * 100).toFixed(2);
                        // Add a plus sign for positive improvement, for clarity
                        if (parseFloat(improvement) > 0) {
                             improvement = `+${improvement}%`;
                        } else {
                             improvement = `${improvement}%`;
                        }
                    }

                    const eventRow = document.createElement('tr');
                    eventRow.className = 'event-data-row hover:bg-gray-50 transition duration-150 ease-in-out';
                    eventRow.innerHTML = `
                        <td>${eventData.eventSwum}</td>
                        <td>${eventData.seedTime}</td>
                        <td>${eventData.resultTime}</td>
                        <td>${eventData.place}</td>
                        <td>${eventData.points}</td>
                        <td>${improvement}</td>
                    `;
                    // Add an empty td for alignment with the first column of the athlete header
                    const emptyTd = document.createElement('td');
                    eventRow.prepend(emptyTd);
                    reportTableBody.appendChild(eventRow);
                });
            });
        }

        /**
         * Initializes the swimmer selection dropdown.
         */
        function populateSwimmerSelect() {
            // Clear existing options, but keep the default "Select an Athlete"
            while (selectSwimmer.children.length > 1) {
                selectSwimmer.removeChild(selectSwimmer.lastChild);
            }

            const uniqueSwimmers = [];
            const swimmerMap = new Map(); // Using a map to track unique swimmer by ID and name

            allAthleteData.forEach(athlete => {
                const key = `${athlete.id}`; // Use the ID which is now guaranteed unique per athlete-record
                if (!swimmerMap.has(key)) {
                    swimmerMap.set(key, {
                        id: athlete.id,
                        firstName: athlete.firstName,
                        lastName: athlete.lastName
                    });
                    uniqueSwimmers.push({
                        id: athlete.id,
                        fullName: `${athlete.firstName} ${athlete.lastName}`
                    });
                }
            });

            // Sort swimmers alphabetically by full name
            uniqueSwimmers.sort((a, b) => a.fullName.localeCompare(b.fullName));

            uniqueSwimmers.forEach(swimmer => {
                const option = document.createElement('option');
                option.value = swimmer.id;
                option.textContent = swimmer.fullName;
                selectSwimmer.appendChild(option);
            });
        }

        /**
         * Generates data for the Specialty (Radar) Chart for a given swimmer.
         * For mock data, this generates a plausible but arbitrary "specialty" profile.
         * In a real app, this would analyze actual performance across strokes.
         */
        function getSpecialtyChartData(swimmerId) {
            const swimmerData = allAthleteData.filter(d => d.id == swimmerId);
            if (swimmerData.length === 0) return null;

            const strokes = ['Freestyle', 'Backstroke', 'Breaststroke', 'Butterfly', 'IM'];
            const specialtyScores = {};
            strokes.forEach(stroke => {
                // Filter for events containing the stroke, ignoring distance for this general specialty score
                const relevantEvents = swimmerData.filter(d => d.eventSwum.toLowerCase().includes(stroke.toLowerCase()) && d.resultTime !== 'NT' && d.resultTime !== 'NS' && d.resultTime !== 'DQ');
                if (relevantEvents.length > 0) {
                    // Calculate average time in seconds for this stroke
                    const sumTimes = relevantEvents.reduce((sum, d) => sum + timeToSeconds(d.resultTime), 0);
                    const avgTime = sumTimes / relevantEvents.length;

                    // Normalize the average time into a score (e.g., 0-100)
                    // Lower time is better, so a lower avgTime should yield a higher score.
                    // Max expected average time for a stroke (adjust as needed for your data range)
                    const max_expected_avg_time = 120; // Example: 2 minutes for an average stroke performance
                    let score = (max_expected_avg_time - avgTime) / max_expected_avg_time * 100;
                    score = Math.max(0, Math.min(100, score)); // Clamp between 0 and 100
                    specialtyScores[stroke] = score;
                } else {
                    specialtyScores[stroke] = 0; // If no data for stroke, score is 0
                }
            });

            return {
                labels: strokes,
                datasets: [{
                    label: `${swimmerData[0].firstName} ${swimmerData[0].lastName}'s Specialty`,
                    data: strokes.map(stroke => specialtyScores[stroke]),
                    backgroundColor: 'rgba(153, 102, 255, 0.4)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(153, 102, 255, 1)'
                }]
            };
        }

        /**
         * Generates data for the Progression (Line) Chart for a given swimmer and event.
         */
        function getProgressionChartData(swimmerId, eventSwum) {
            const swimmerEventData = allAthleteData
                .filter(d => d.id == swimmerId && d.eventSwum === eventSwum && d.resultTime !== 'NT' && d.resultTime !== 'NS' && d.resultTime !== 'DQ')
                .sort((a, b) => new Date(a.meetDate) - new Date(b.meetDate)); // Sort by date

            if (swimmerEventData.length === 0) return null;

            return {
                labels: swimmerEventData.map(d => d.meetDate),
                datasets: [{
                    label: `${eventSwum} Time Progression`,
                    data: swimmerEventData.map(d => timeToSeconds(d.resultTime)),
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    pointBackgroundColor: 'rgb(75, 192, 192)'
                }]
            };
        }

        /**
         * Initializes or updates the Specialty (Radar) Chart.
         */
        function updateSpecialtyChart(swimmerId) {
            if (specialtyChartInstance) {
                specialtyChartInstance.destroy(); // Destroy existing chart
            }
            const chartData = getSpecialtyChartData(swimmerId);
            const ctx = document.getElementById('specialtyChart').getContext('2d');

            if (!chartData) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                return;
            }

            specialtyChartInstance = new Chart(ctx, {
                type: 'radar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: '#e2e8f0' // gray-200
                            },
                            grid: {
                                color: '#cbd5e0' // gray-300
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#4a5568' // gray-700
                            },
                            min: 0,
                            max: 100, // Assuming scores from 0-100
                            ticks: {
                                stepSize: 20,
                                backdropColor: 'rgba(255, 255, 255, 0.75)',
                                color: '#4a5568'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#4a5568'
                            }
                        },
                        title: {
                            display: false, // Title is in H3 above canvas
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Initializes or updates the Progression (Line) Chart.
         */
        function updateProgressionChart(swimmerId) {
            if (progressionChartInstance) {
                progressionChartInstance.destroy(); // Destroy existing chart
            }

            const swimmerEvents = [...new Set(allAthleteData.filter(d => d.id == swimmerId).map(d => d.eventSwum))];
            const ctx = document.getElementById('progressionChart').getContext('2d');

            if (swimmerEvents.length === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                 return;
            }

            // For simplicity, we'll pick the first event for now or you can add another dropdown to select event
            const selectedEventForProgression = swimmerEvents[0];
            const chartData = getProgressionChartData(swimmerId, selectedEventForProgression);

            if (!chartData) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas
                 return;
            }

            progressionChartInstance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Meet Date',
                                color: '#4a5568'
                            },
                            ticks: {
                                color: '#4a5568'
                            },
                            grid: {
                                color: '#e2e8f0'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Time (Seconds)',
                                color: '#4a5568'
                            },
                            ticks: {
                                color: '#4a5568',
                                callback: function(value, index, values) {
                                    return secondsToTime(value); // Convert seconds back to MM:SS.ms
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            },
                            reverse: true, // Lower time is better, so reverse Y-axis
                            min: 0
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#4a5568'
                            }
                        },
                        title: {
                            display: false, // Title is in H3 above canvas
                        },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${secondsToTime(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // Filters
        function applyFilters() {
            const nameFilter = filterNameInput.value.toLowerCase();
            const categoryFilter = filterCategoryInput.value.toLowerCase();
            const eventFilter = filterEventInput.value.toLowerCase();
            const startDateStr = filterStartDateInput.value;
            const endDateStr = filterEndDateInput.value;

            // Parse dates, setting to null if empty for optional filtering
            const startDate = startDateStr ? new Date(startDateStr + 'T00:00:00') : null; // Add time to ensure date comparison works correctly
            const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59') : null;     // Add time to ensure date comparison works correctly

            filteredAthleteData = allAthleteData.filter(athlete => {
                const fullName = `${athlete.firstName} ${athlete.lastName}`.toLowerCase();
                const matchesName = nameFilter === '' || fullName.includes(nameFilter) || athlete.lastName.toLowerCase().includes(nameFilter) || athlete.firstName.toLowerCase().includes(nameFilter);
                const matchesCategory = categoryFilter === '' || athlete.category.toLowerCase().includes(categoryFilter);
                const matchesEvent = eventFilter === '' || athlete.eventSwum.toLowerCase().includes(eventFilter);

                let matchesDate = true;
                if (startDate || endDate) {
                    const meetDate = new Date(athlete.meetDate + 'T12:00:00'); // Ensure consistent time for comparison
                    matchesDate = (!startDate || meetDate >= startDate) &&
                                  (!endDate || meetDate <= endDate);
                }

                return matchesName && matchesCategory && matchesEvent && matchesDate;
            });

            renderTable(filteredAthleteData);
        }

        function resetFilters() {
            filterNameInput.value = '';
            filterCategoryInput.value = '';
            filterEventInput.value = '';
            filterStartDateInput.value = ''; // Clear date inputs
            filterEndDateInput.value = '';   // Clear date inputs
            // No need to reload data from JSON here, just re-apply filters on current allAthleteData
            filteredAthleteData = [...allAthleteData];
            renderTable(filteredAthleteData);
        }

        // Event Listeners
        applyFiltersButton.addEventListener('click', applyFilters);
        resetFiltersButton.addEventListener('click', resetFilters);
        printReportButton.addEventListener('click', () => {
            window.print();
        });

        selectSwimmer.addEventListener('change', (event) => {
            const selectedSwimmerId = event.target.value;
            if (selectedSwimmerId) {
                updateSpecialtyChart(selectedSwimmerId);
                updateProgressionChart(selectedSwimmerId);
            } else {
                // Clear charts if no swimmer selected
                if (specialtyChartInstance) specialtyChartInstance.destroy();
                if (progressionChartInstance) progressionChartInstance.destroy();
            }
        });

        // Event listener for JSON file selection
        jsonFileSelector.addEventListener('change', (event) => {
            // Reset text/category/event filters completely when changing the data source (file)
            filterNameInput.value = '';
            filterCategoryInput.value = '';
            filterEventInput.value = '';
            // Don't clear date inputs here if user wants to keep a date range selected
            // You might want to adjust this behavior based on user preference
            fetchAndRenderData(event.target.value);
        });

        // Initial render on page load: populate selector, then load default data
        document.addEventListener('DOMContentLoaded', () => {
            populateJsonFileSelector();
            // Set the default selected value to "2025resultsweek01.json"
            jsonFileSelector.value = "2025resultsweek01.json";
            const defaultFile = jsonFileSelector.value;
            fetchAndRenderData(defaultFile);
        });
    </script>
</body>
</html>
